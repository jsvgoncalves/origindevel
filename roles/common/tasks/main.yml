---
- name: Change hostname
  hostname: name=origindevel

- name: Update All packages
  become: yes
  become_user: root
  dnf: >
    name=* state=latest
  when: ansible_os_family == "RedHat"

- name: Install common packages
  become: yes
  become_user: root
  dnf: >
    name={{ item }} state=latest
  when: ansible_os_family == "RedHat"
  with_items:
    - "akmod-VirtualBox"
    - "augeas"
    - "bzr"
    - "bc"
    - "bridge-utils"
    - "bzip2"
    - "bind"
    - "btrfs-progs-devel"
    - "ctags"
    - "device-mapper-devel"
    - "ethtool"
    - "e2fsprogs"
    - "fontconfig"
    - "glibc-static"
    - "gnuplot"
    - "httpie"
    - "hg"
    - "jq"
    - "libselinux-devel"
    - "libnetfilter_queue-devel"
    - "make"
    - "mlocate"
    - "ntp"
    - "openldap-clients"
    - "openvswitch"
    - "rubygems"
    - "screen"
    - "socat"
    - "sqlite-devel"
    - "sysstat"
    - "tig"
    - "tmux"
    - "unzip"
    - "vim"
    - "wget"
    - "xfsprogs"
    - "Xvfb"
    - "git"
    - "polkit"
    - "gcc"
    - "make"
    - "automake"
    - "gcc-c++"
    - "kernel-devel"
    - "kernel-headers"
    - "kernel-tools-libs"
    - "kernel-tools-libs-devel"
    - "python"
    - "python-virtualenv"
    - "python-devel"
    - "htop"
    - "nload"
    - "mlocate"
    - "policycoreutils-python"
    - "tmux"
    - "net-tools"
    - "emacs-nox"
    - "httpd-tools"
    - "wget"
    - "curl"
    - "bind-utils"
    - "nc"
    - "docker"
    - "golang"
    - "python3-devel"
    - "ruby"
    - "git"
    - "ethtool"
    - "nodejs"
    - "npm"

- name: Restart guest to load the latest kernel
  shell: sleep 2 && shutdown -r now "Ansible updates triggered"
  async: 1
  poll: 0
  sudo: true
  ignore_errors: true

- name: Waiting for server to come back up
  local_action: wait_for host=10.245.2.2 state=started delay=20 timeout=300
  sudo: false

- name: Rebuild kernel modules
  shell: akmods --kernel $(uname -r)

- name: Restart vboxadd.service
  service: name=vboxadd state=restarted

- name: Restart guest to load the latest akmods module
  shell: sleep 2 && shutdown -r now "Ansible updates triggered"
  async: 1
  poll: 0
  sudo: true
  ignore_errors: true

- name: Waiting for server to come back up
  local_action: wait_for host=10.245.2.2 state=started delay=20 timeout=300
  sudo: false

- name: Install custom .files
  template: src=bashrc dest={{home_path}}/.bashrc group={{default_user_group}} owner={{default_user}}

- name: Replace current emacs setup
  command: /usr/bin/rm -rf {{home_path}}/.emacs.d
- git: repo=https://github.com/PI-Victor/.emacs.d.git dest={{home_path}}/.emacs.d clone=yes
- command: cp -p {{home_path}}/.emacs.d/.emacs {{home_path}}/

- name: Fetch tmux setup
  git: repo=https://github.com/PI-Victor/.tmux_conf.git dest={{home_path}}/.tmux_conf clone=yes
- command: cp -p {{home_path}}/.tmux_conf/.tmux.conf {{home_path}}/

- name: Install bower globally
  command: /usr/bin/npm install -g bower --allow-root

- name: Switch SElinux to permissive mode.
  selinux: policy=targeted state=permissive

- name: Ensure docker is added to systemctl
  become_user: root
  service: name=docker enabled=yes state=restarted

- name: Copy custom docker-storage
  template: src=docker-storage dest=/etc/sysconfig/docker-storage
  notify:
    - restart docker

- name: Copy custom docker file
  template: src=docker dest=/etc/sysconfig/docker
  notify:
    - restart docker

- name: Create docker user group
  group: name=docker state=present

- name: Add user to docker group
  user: name={{default_user}} groups=docker append=yes

- name: Ensure that firewalld is off
  service: name=firewalld enabled=no state=stopped

- name: Remove dnf cached files
  command: /usr/bin/dnf clean all

- name: Create /scripts
  file: path=/scripts state=directory

- name: Check for and create {{home_path}}/openshift
  file: path={{home_path}}/openshift state=directory

# TODO: improve this and move it to a specific config
- name: Install Openshift Origin V3 as a service from your host mounted $GOPATH
  copy: src=files/origin dest={{home_path}}/openshift/origin
- template: src=openshift.service dest=/usr/lib/systemd/system/openshift.service
  notify: restart systemctl
- service: name=openshift enabled=yes state=started

- name: Clone rhcarvalho/openshift-devtools.git
  git: repo=https://github.com/rhcarvalho/openshift-devtools.git dest=/scripts clone=yes
