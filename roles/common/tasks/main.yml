---
- name: Update All packages
  become: yes
  become_user: root
  dnf: >
    name=* state=latest
  when: ansible_os_family == "RedHat"

- name: Install common packages
  become: yes
  become_user: root
  dnf: >
    name={{ item }} state=latest
  when: ansible_os_family == "RedHat"
  with_items:
    - "augeas"
    - "bzr"
    - "bridge-utils"
    - "bzip2"
    - "bind"
    - "btrfs-progs-devel"
    - "ctags"
    - "device-mapper-devel"
    - "ethtool"
    - "e2fsprogs"
    - "fontconfig"
    - "glibc-static"
    - "gnuplot"
    - "httpie"
    - "hg"
    - "jq"
    - "libselinux-devel"
    - "libnetfilter_queue-devel"
    - "make"
    - "mlocate"
    - "ntp"
    - "openldap-clients"
    - "openvswitch"
    - "rubygems"
    - "screen"
    - "socat"
    - "sqlite-devel"
    - "sysstat"
    - "tig"
    - "tmux"
    - "unzip"
    - "vim"
    - "wget"
    - "xfsprogs"
    - "Xvfb"
    - "git"
    - "polkit"
    - "gcc"
    - "make"
    - "automake"
    - "gcc-c++"
    - "kernel-devel"
    - "python"
    - "python-virtualenv"
    - "python-devel"
    - "htop"
    - "nload"
    - "mlocate"
    - "policycoreutils-python"
    - "tmux"
    - "net-tools"
    - "emacs-nox"
    - "httpd-tools"
    - "wget"
    - "curl"
    - "bind-utils"
    - "nc"
    - "docker"
    - "golang"
    - "python3-devel"
    - "ruby"
    - "git"
    - "ethtool"
    - "nodejs"
    - "npm"

- name: Install custom .files
  template: src=bashrc dest={{home_path}}/.bashrc group={{default_user_group}} owner={{default_user}}

- name: Remove current setup
  command: /usr/bin/rm -rf {{home_path}}/.emacs.d

- name: Fetch emacs setup repo
  git: repo=https://github.com/PI-Victor/.emacs.d.git dest={{home_path}}/.emacs.d clone=yes

- name: Copy the .emacs to ~
  command: cp -p {{home_path}}/.emacs.d/.emacs {{home_path}}/

- name: Fetch tmux setup repo
  git: repo=https://github.com/PI-Victor/.tmux_conf.git dest={{home_path}}/.tmux_conf clone=yes

- name: Copy the .tmux.conf to ~
  command: cp -p {{home_path}}/.tmux_conf/.tmux.conf {{home_path}}/

- name: Install bower globally
  command: /usr/bin/npm install -g bower --allow-root

- name: Switch SElinux to permissive mode.
  selinux: policy=targeted state=permissive

- name: Ensure docker is added to systemctl
  become_user: root
  service: name=docker enabled=yes state=started

- name: Copy custom docker config and restart service
  template: src=docker dest=/etc/sysconfig/docker
  template: src=docker-storage dest=/etc/sysconfig/docker-storage
  notify:
    - restart docker

- name: Ensure that firewalld is off
  become_user: root
  service: name=firewalld enabled=no state=stopped

- name: Remove dnf cached files
  command: /usr/bin/dnf clean all

- name: Create /scripts
  stat: path=/scripts
  register: st
  become_user: root

- command: /usr/bin/mkdir /scripts
  when: st.stat.exists == False

- name: Clone rhcarvalho/openshift-devtools.git
  git: repo=https://github.com/rhcarvalho/openshift-devtools.git dest=/scripts clone=yes

# TODO: improve this and move it to a specific config
- name: Check if we have origin v3 built and install it as a service.
  stat: path="{{ origin_path }}"/_output/local/bin/linux/amd64/openshift
  register: st

- name: Check for and create {{home_path}}/openshift/origin
  stat: path={{home_path}}/openshift/origin
  register: stdir

- command: /usr/bin/mkdir -p {{home_path}}/openshift/origin
  when: stdir.stat.exists == False

- template: src=openshift.service dest=/usr/lib/systemd/openshift.service
  when: st.stat.exists

- service: name=openshift state=enabled
  notify: restart systemctl
  when: st.stat.exists
